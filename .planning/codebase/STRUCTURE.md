# Codebase Structure

**Analysis Date:** 2026-02-07

## Directory Layout

```
nanoclaw/
├── src/                        # TypeScript source (transpiled to dist/)
│   ├── index.ts               # Main application: routers, message loops, IPC
│   ├── container-runner.ts    # Container spawning and IPC output parsing
│   ├── group-queue.ts         # Per-group concurrency management
│   ├── task-scheduler.ts      # Scheduled task polling and execution
│   ├── db.ts                  # SQLite database layer
│   ├── config.ts              # Configuration from env vars
│   ├── types.ts               # TypeScript interfaces
│   ├── slack.ts               # Slack Socket Mode integration
│   ├── whatsapp-auth.ts       # WhatsApp authentication CLI
│   ├── mount-security.ts      # Volume mount validation
│   └── logger.ts              # Pino logger instance
├── store/                     # Runtime state (generated, not committed)
│   ├── auth/                  # WhatsApp auth credentials (Baileys)
│   ├── messages.db            # SQLite: chats, messages, tasks, sessions, state
│   └── nanoclaw.db           # Placeholder (unused)
├── data/                      # Per-group runtime data (generated)
│   ├── env/                   # Filtered env vars for container injection
│   ├── ipc/                   # Inter-process communication
│   │   ├── main/              # Main group IPC (can send to any group)
│   │   │   ├── messages/      # JSON files: type, chatJid, text
│   │   │   └── tasks/         # JSON files: type, taskId, groupFolder
│   │   └── {group-name}/      # Other group IPC (isolated, can only send within group)
│   │       ├── messages/
│   │       └── tasks/
│   └── sessions/              # Per-group Claude session data
│       └── {group-folder}/
│           └── .claude/       # Mounted to /home/node/.claude in container
├── groups/                    # Per-group persistent files
│   ├── main/                  # Main group directory
│   │   ├── CLAUDE.md         # Memory file for main group
│   │   └── logs/             # Log files (if created)
│   ├── global/               # Shared read-only memory (mounted to all non-main groups)
│   │   └── CLAUDE.md         # Optional shared memory
│   └── {group-name}/         # Other group directories
│       ├── CLAUDE.md         # Memory file (isolated)
│       └── logs/             # Group-specific logs
├── dist/                     # Compiled JavaScript (generated by tsc)
│   └── *.js
├── container/                # Container image configuration
│   ├── build.sh             # Build script for agent container
│   ├── Dockerfile           # Container specification
│   ├── skills/              # Skills available to agents
│   │   └── agent-browser.md # Browser automation tool
│   └── src/                 # Container startup code (agent-runner)
├── docs/                    # Documentation
│   ├── REQUIREMENTS.md      # Architecture decisions
│   └── ...
├── config-examples/         # Example configuration files
├── launchd/                 # macOS service configuration
├── assets/                  # Logo and images
├── .planning/              # GSD planning outputs
│   └── codebase/
│       ├── ARCHITECTURE.md
│       └── STRUCTURE.md
├── tsconfig.json           # TypeScript compiler options
├── package.json            # Dependencies and scripts
├── package-lock.json       # Locked dependency versions
├── .env                    # Runtime config (not committed)
├── .env.example            # Template for .env
├── .prettierrc             # Code formatting config
├── README.md               # User-facing documentation
├── CLAUDE.md               # Developer reference for Claude Code
└── LICENSE
```

## Directory Purposes

**`src/`:**
- Purpose: All TypeScript source code for the main router process
- Contains: Message routing, container orchestration, state management, integrations
- Key files: `index.ts` (31KB, main logic), `container-runner.ts` (15KB), `db.ts` (17KB)

**`store/`:**
- Purpose: WhatsApp authentication and SQLite database
- Contains: Never delete this folder or you'll lose all message history and auth
- Generated by: Baileys library (`store/auth/`), database initialization (`messages.db`)

**`data/`:**
- Purpose: Runtime working directory for per-group execution
- Contains: IPC message queues, session data, filtered environment variables
- Lifecycle: Safe to delete; will be recreated on next run
- Structure: Each group has isolated `ipc/` directory preventing cross-group IPC

**`groups/`:**
- Purpose: Persistent per-group data visible to agents
- Contains: `CLAUDE.md` memory files, log directories
- Access: Main group sees full project root; other groups see only their folder + global (read-only)
- Example: `groups/main/CLAUDE.md` is mounted as `/workspace/group/CLAUDE.md` in containers

**`dist/`:**
- Purpose: Compiled JavaScript (output of `npm run build`)
- Generated by: TypeScript compiler (`tsc`)
- Run via: `npm start` (runs `node dist/index.js`)

**`container/`:**
- Purpose: Docker/Apple Container definition and startup logic
- Contains: Dockerfile, build script, container-side agent-runner code
- Build: Run `./container/build.sh` to rebuild the nanoclaw-agent:latest image
- Skills: Tools available to agents in containers (e.g., `agent-browser.md` for web access)

**`.env`:**
- Purpose: Runtime configuration and secrets
- Contains: WhatsApp auth (auto-generated by Baileys), Slack tokens, Claude API key or AWS credentials
- Source: Copy from `.env.example` and fill in your values
- Never commit: Secrets stay local

**`docs/`:**
- Purpose: Architecture decisions and requirements
- Key file: `REQUIREMENTS.md` documents architectural choices (e.g., why container isolation, why SQLite)

## Key File Locations

**Entry Points:**

- `src/index.ts`: Main process entry point; defines all routers, loops, and core logic (line 990: `main()` function)
- `package.json` script `start`: Runs `node dist/index.js`
- `package.json` script `dev`: Runs `tsx src/index.ts` with `.env` loaded

**Configuration:**

- `src/config.ts`: Centralized config; all constants exported from here
- `.env`: Runtime environment variables (API keys, assistant name, etc.)
- `src/types.ts`: TypeScript interfaces for RegisteredGroup, NewMessage, ScheduledTask, etc.

**Core Logic:**

- `src/index.ts`: WhatsApp connection, message loops, IPC watcher, group registration, all state
- `src/container-runner.ts`: Volume mount configuration, container spawning, output parsing
- `src/group-queue.ts`: Concurrency management, retry logic, graceful shutdown
- `src/task-scheduler.ts`: Scheduled task polling and execution
- `src/db.ts`: SQLite schema, CRUD for all entities

**Testing:**

- No automated tests in codebase; testing is manual via Claude Code

**State Files:**

- `store/messages.db`: SQLite database with all messages, tasks, groups, sessions
- `store/auth/`: WhatsApp auth credentials (generated by Baileys, do not edit)
- `groups/{name}/CLAUDE.md`: Per-group memory; visible to agents
- `data/ipc/{group}/messages/`: JSON files from agents to send messages
- `data/ipc/{group}/tasks/`: JSON files from agents to manage tasks

## Naming Conventions

**Files:**

- `*.ts`: TypeScript source
- `*.js`: Compiled JavaScript (in dist/)
- `.ts` not `.js` during development; `npm run dev` uses tsx ESM loader for hot reload
- Filenames: kebab-case or camelCase (e.g., `container-runner.ts`, `groupQueue`, `db.ts`)

**Directories:**

- `src/`: Lowercase, brief names
- `groups/{group-name}/`: Group folders use the name from RegisteredGroup.folder (lowercase, no spaces)
- `data/ipc/{group-name}/`: Mirror of group names for isolation

**Variables:**

- In-memory state: camelCase (e.g., `registeredGroups`, `lastAgentTimestamp`, `sessions`)
- Database columns: snake_case (e.g., `group_folder`, `chat_jid`, `last_run`)
- Function names: camelCase, verb-first (e.g., `processGroupMessages`, `runContainerAgent`, `sendMessage`)

**Types:**

- Interfaces: PascalCase (e.g., `RegisteredGroup`, `ContainerInput`, `GroupState`)
- Enums: Not used (TypeScript literal types preferred)

## Where to Add New Code

**New Feature (e.g., Gmail integration):**
- Implementation: `src/gmail.ts` (new file, follows pattern of `src/slack.ts`)
- Integration: Hook into `src/index.ts` main function
- Configuration: Add env vars to `src/config.ts`
- Types: Add interfaces to `src/types.ts` if needed

**New Message Handler (new channel type):**
- Storage: Add `storeGenericMessage()` call in message handler
- Routing: Call `queue.enqueueMessageCheck(jid)` when message arrives
- Sending: Add case to `sendMessage()` function in index.ts
- Example: See `src/slack.ts` for reference

**New Agent Tool/Skill:**
- Implementation: Add markdown file to `container/skills/` (not in src/)
- Access: Agents read these files from `/workspace/skills/`
- Build: Include in `container/Dockerfile` or mount at runtime

**New Scheduled Task Type:**
- Storage: Add `schedule_type` value to `ScheduledTask.schedule_type` union in `src/types.ts`
- Execution: Add case in `task-scheduler.ts` `runTask()` function to calculate `nextRun`
- Example: Existing types are 'cron', 'interval', 'once'

**New IPC Command Type:**
- Handler: Add case to `processTaskIpc()` function in `src/index.ts` (line 522)
- Protocol: Define JSON schema in comments near that case
- Authorization: Check `isMain` flag if needed
- Example: Existing commands are 'create_task', 'pause_task', 'register_group', etc.

**New Database Table:**
- Schema: Add CREATE TABLE in `src/db.ts` inside `initDatabase()` (line 17)
- CRUD: Export functions from `db.ts` for queries
- Persistence: Called from relevant layers (e.g., container-runner, task-scheduler)
- Migration: Wrap ALTER TABLE in try-catch in case table was already modified

**Utilities (shared helpers):**
- Location: `src/` (no separate utils folder; kept flat for simplicity)
- Export: From module defining the utility
- Example: `validateAdditionalMounts()` is in `src/mount-security.ts`

## Special Directories

**`store/auth/`:**
- Purpose: WhatsApp Baileys authentication credentials
- Generated: By `src/whatsapp-auth.ts` when user scans QR code
- Files: `creds.json`, `*.json` for signal keys (DO NOT EDIT)
- Lifecycle: Back this up; losing it means re-authenticating WhatsApp

**`data/ipc/`:**
- Purpose: Temporary file-based message queue between containers and host
- Usage Pattern:
  1. Agent running in container writes JSON to `data/ipc/{group-folder}/messages/msg-{timestamp}.json`
  2. IPC watcher polls every 1s, reads file, processes, deletes
  3. If error, moves to `data/ipc/errors/` for manual inspection
- Isolation: Each group's folder is mounted separately to that group's container, preventing cross-group access

**`data/sessions/`:**
- Purpose: Claude Code conversation session data (not agent memory)
- Access: Each group has isolated `data/sessions/{group-folder}/.claude/` mounted to container
- Isolation: Prevents one group's agent from hijacking another group's session

**`groups/global/`:**
- Purpose: Optional shared memory readable by all non-main groups
- Access: Mounted read-only to `/workspace/global` in non-main containers
- Example: Could contain shared templates or reference data
- Note: Not required; safe to leave empty

**`dist/`:**
- Purpose: Compiled JavaScript output
- Generated: `npm run build` transpiles src/ to dist/
- Committed: Yes (for quick deploys without build step)
- Pattern: Ignore when debugging; modify src/ then rebuild

---

*Structure analysis: 2026-02-07*
