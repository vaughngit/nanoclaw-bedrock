---
phase: 06-mcp-server-configuration-and-filtering
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/config-loader.ts
  - nanoclaw.config.jsonc
  - container/agent-runner/src/mcp-filter.ts
autonomous: true

must_haves:
  truths:
    - "MCP servers in nanoclaw.config.jsonc accept a modes array per server"
    - "Servers without a modes field default to being available in both modes"
    - "Config validation rejects unknown keys in MCP server definitions (z.strictObject)"
    - "Reserved server name 'nanoclaw' is caught and warned about"
  artifacts:
    - path: "src/config-loader.ts"
      provides: "McpServerSchema + mcpServers field in NanoClawConfigSchema"
      contains: "mcpServers"
      exports: ["NanoClawConfig", "McpServerConfig as NanoClawMcpServerConfig"]
    - path: "container/agent-runner/src/mcp-filter.ts"
      provides: "Mode filtering and SDK translation functions"
      exports: ["filterMcpServersByMode"]
    - path: "nanoclaw.config.jsonc"
      provides: "Uncommented mcpServers section with real examples"
      contains: "mcpServers"
  key_links:
    - from: "src/config-loader.ts"
      to: "nanoclaw.config.jsonc"
      via: "Zod validation of mcpServers field"
      pattern: "mcpServers.*z\\.record"
    - from: "container/agent-runner/src/mcp-filter.ts"
      to: "@anthropic-ai/claude-agent-sdk"
      via: "translates NanoClaw format to SDK McpStdioServerConfig | McpSSEServerConfig | McpHttpServerConfig"
      pattern: "McpStdioServerConfig|McpSSEServerConfig|McpHttpServerConfig"
---

<objective>
Add MCP server schema to config-loader, uncomment the config template's mcpServers section, and create the filtering/translation module.

Purpose: Establishes the data model for mode-tagged MCP servers and the logic to filter them by execution mode and translate to SDK format. This is the foundation that Plan 02 wires into the runner pipeline.

Output: Extended Zod schema accepting mcpServers in config, working config template with real examples, and a standalone mcp-filter.ts module with filterMcpServersByMode().
</objective>

<execution_context>
@/Users/alvin/.claude/get-shit-done/workflows/execute-plan.md
@/Users/alvin/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-mcp-server-configuration-and-filtering/06-CONTEXT.md
@.planning/phases/06-mcp-server-configuration-and-filtering/06-RESEARCH.md
@src/config-loader.ts
@nanoclaw.config.jsonc
@container/agent-runner/node_modules/@anthropic-ai/claude-agent-sdk/sdk.d.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extend Zod schema with mcpServers field and uncomment config template</name>
  <files>src/config-loader.ts, nanoclaw.config.jsonc</files>
  <action>
In `src/config-loader.ts`:

1. Add `McpServerSchema` using `z.strictObject()` (consistent with project pattern -- catches typos in server config keys):
   ```typescript
   const McpServerSchema = z.strictObject({
     command: z.string().optional(),
     args: z.array(z.string()).optional(),
     env: z.record(z.string(), z.string()).optional(),
     type: z.enum(['stdio', 'sse', 'http']).optional(),
     url: z.string().optional(),
     headers: z.record(z.string(), z.string()).optional(),
     modes: z.array(z.string()).default(['host', 'container']),
   });
   ```

2. Add a `.refine()` on McpServerSchema for mutual exclusivity:
   - stdio servers: must have `command`, must NOT have `url`
   - sse/http servers: must have `url`, must NOT have `command`
   - If `type` is omitted (defaults to stdio behavior): must have `command`
   This gives clear user errors instead of silent misconfiguration.

3. Add `mcpServers` to `NanoClawConfigSchema`:
   ```typescript
   mcpServers: z.record(z.string(), McpServerSchema).optional().default({}),
   ```
   Use `.optional().default({})` so absent field defaults to empty (no servers).

4. Export the inferred MCP server type for use by mcp-filter.ts:
   ```typescript
   export type NanoClawMcpServer = z.output<typeof McpServerSchema>;
   ```

5. Update the startup log line to include MCP server count:
   ```typescript
   process.stderr.write(`[config] Config loaded: executionMode=${config.executionMode}${config.hostSecurity ? `, sandbox=${config.hostSecurity.sandbox}` : ''}${Object.keys(config.mcpServers).length > 0 ? `, mcpServers=${Object.keys(config.mcpServers).length}` : ''}\n`);
   ```

In `nanoclaw.config.jsonc`:

1. Uncomment the `mcpServers` section (lines ~58-87). Remove the "UNCOMMENT when ready (requires Phase 6)" comment.

2. Provide two uncommented real examples:
   - Context7 (library docs): stdio server, modes: ["host"] (can't run stdio in container)
   - A commented-out filesystem example with "${HOME}/projects" showing env var expansion

3. Keep the HTTP/SSE example commented out but present as documentation.

4. Ensure the "nanoclaw" server name is NOT used in any example (reserved for IPC MCP).

IMPORTANT: The existing expandEnvVars() already handles all string values recursively after JSON.parse and before Zod validation. Do NOT add separate env var expansion for MCP server fields -- it's already handled by the pipeline.
  </action>
  <verify>
Run `npx tsx src/config-loader.ts` (or `npm run build` if available) to verify the schema compiles without errors. Check that the config file parses successfully with the new mcpServers field by examining the startup log output.
  </verify>
  <done>
- McpServerSchema validates server definitions with z.strictObject()
- mcpServers field in NanoClawConfigSchema accepts Record<string, McpServer>
- .refine() produces clear errors for misconfigured servers (e.g., sse type without url)
- NanoClawMcpServer type exported for downstream use
- Config template has uncommented mcpServers section with real Context7 example
- Startup log shows mcpServers count when > 0
  </done>
</task>

<task type="auto">
  <name>Task 2: Create mcp-filter.ts with filtering and SDK translation</name>
  <files>container/agent-runner/src/mcp-filter.ts</files>
  <action>
Create `container/agent-runner/src/mcp-filter.ts` with:

1. Define a local `NanoClawMcpServer` interface matching the Zod output shape (do NOT import from config-loader.ts -- agent-runner is a separate build target with its own dependencies):
   ```typescript
   interface NanoClawMcpServer {
     command?: string;
     args?: string[];
     env?: Record<string, string>;
     type?: 'stdio' | 'sse' | 'http';
     url?: string;
     headers?: Record<string, string>;
     modes: string[];
   }
   ```

2. Import SDK types from the agent SDK:
   ```typescript
   import type { McpStdioServerConfig, McpSSEServerConfig, McpHttpServerConfig } from '@anthropic-ai/claude-agent-sdk';
   ```

3. Define the SDK union type for translated servers:
   ```typescript
   type SdkMcpServerConfig = McpStdioServerConfig | McpSSEServerConfig | McpHttpServerConfig;
   ```

4. Create `translateToSdkFormat(server: NanoClawMcpServer): SdkMcpServerConfig`:
   - If `type === 'sse'`: return `{ type: 'sse', url: server.url!, headers: server.headers }`
   - If `type === 'http'`: return `{ type: 'http', url: server.url!, headers: server.headers }`
   - Otherwise (stdio, default): return `{ command: server.command!, args: server.args, env: server.env }`

5. Create `filterMcpServersByMode(servers: Record<string, NanoClawMcpServer>, currentMode: string)`:
   Returns `{ active: Record<string, SdkMcpServerConfig>, filtered: Array<{ name: string, modes: string[] }> }`.

   Logic:
   - Iterate entries of `servers`
   - RESERVED NAME CHECK: If name is `'nanoclaw'`, log warning and skip (do not include in active or filtered -- it would override the IPC MCP server)
   - If `server.modes.includes(currentMode)`: add to `active` (translated to SDK format)
   - Else: add to `filtered` with name and modes (for logging)
   - Return both sets

6. Export `filterMcpServersByMode` and `NanoClawMcpServer` (the interface) and `SdkMcpServerConfig`.

Use `console.error` for the reserved name warning (agent-runner uses console.error for logging, prefixed with `[agent-runner]`). Follow the existing `log()` helper pattern:
```typescript
function log(message: string): void {
  console.error(`[mcp-filter] ${message}`);
}
```
  </action>
  <verify>
Run `cd /Users/alvin/dev/nanoclaw && npm run build:agent` to verify mcp-filter.ts compiles successfully within the agent-runner build. Check that the module exports filterMcpServersByMode by examining the compiled output.
  </verify>
  <done>
- mcp-filter.ts exists with filterMcpServersByMode() and translateToSdkFormat()
- Reserved name "nanoclaw" is detected and warned about (not included in active servers)
- Active servers are translated to SDK format (McpStdioServerConfig | McpSSEServerConfig | McpHttpServerConfig)
- Filtered servers include name and modes for logging
- Module compiles within agent-runner build
  </done>
</task>

</tasks>

<verification>
1. `npm run build` succeeds (main app compiles with extended schema)
2. `npm run build:agent` succeeds (agent-runner compiles with new mcp-filter module)
3. Config file with mcpServers parses without errors
4. Config file WITHOUT mcpServers still parses (defaults to empty object)
5. An mcpServers entry with a typo key (e.g., "comand" instead of "command") triggers z.strictObject rejection
</verification>

<success_criteria>
- Zod schema accepts mcpServers with mode-tagged server definitions
- Config template ships with real, uncommented MCP server examples
- mcp-filter.ts provides filtering by mode and translation to SDK types
- Both build targets compile successfully
</success_criteria>

<output>
After completion, create `.planning/phases/06-mcp-server-configuration-and-filtering/06-01-SUMMARY.md`
</output>
