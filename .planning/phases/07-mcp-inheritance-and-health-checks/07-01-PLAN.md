---
phase: 07-mcp-inheritance-and-health-checks
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - container/agent-runner/src/mcp-filter.ts
  - container/agent-runner/src/index.ts
autonomous: true

must_haves:
  truths:
    - "Host mode main group agents load global MCP servers from ~/.claude/settings.json via SDK settingSources"
    - "Startup logs show config servers and global servers in separate sections so the user can see where each came from"
    - "Startup logs show per-server health status (connected/failed) from the SDK init message"
    - "Health check timing is logged (total ms from query start to init message)"
    - "Health checks do not block startup -- the agent always starts even if servers fail"
    - "Non-main groups do NOT get global MCP server inheritance (security boundary from Phase 5)"
    - "Config servers take precedence over global servers on name collision (logged as overridden)"
  artifacts:
    - path: "container/agent-runner/src/mcp-filter.ts"
      provides: "readGlobalMcpServerNames() and logMcpServerSources() functions"
      exports: ["readGlobalMcpServerNames", "logMcpServerSources"]
    - path: "container/agent-runner/src/index.ts"
      provides: "Global server reading, source logging, health status logging from init message"
      contains: "mcp_servers"
  key_links:
    - from: "container/agent-runner/src/index.ts"
      to: "container/agent-runner/src/mcp-filter.ts"
      via: "import readGlobalMcpServerNames, logMcpServerSources"
      pattern: "import.*readGlobalMcpServerNames.*logMcpServerSources.*mcp-filter"
    - from: "container/agent-runner/src/index.ts"
      to: "~/.claude/settings.json"
      via: "readGlobalMcpServerNames reads CLAUDE_CONFIG_DIR/settings.json"
      pattern: "readGlobalMcpServerNames"
    - from: "container/agent-runner/src/index.ts"
      to: "SDK init message"
      via: "message.mcp_servers in init handler"
      pattern: "message\\.mcp_servers"
---

<objective>
Add global MCP server inheritance visibility and health status reporting to the agent-runner.

Purpose: Host mode main group agents should log which MCP servers come from the config file versus the user's global ~/.claude/settings.json, and startup should report the connection health of all configured MCP servers. This gives users visibility into their full MCP ecosystem and immediate feedback on server availability.

Output: Modified mcp-filter.ts with global server reading and source logging functions, modified index.ts with source logging calls and health status capture from the SDK init message.
</objective>

<execution_context>
@/Users/alvin/.claude/get-shit-done/workflows/execute-plan.md
@/Users/alvin/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-mcp-inheritance-and-health-checks/07-RESEARCH.md
@.planning/phases/07-mcp-inheritance-and-health-checks/07-CONTEXT.md
@container/agent-runner/src/mcp-filter.ts
@container/agent-runner/src/index.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add global server reading and source logging to mcp-filter.ts</name>
  <files>container/agent-runner/src/mcp-filter.ts</files>
  <action>
Add two new exported functions to mcp-filter.ts:

1. `readGlobalMcpServerNames()`: Reads `~/.claude/settings.json` and returns an array of MCP server names found there. This is for LOGGING ONLY -- the SDK's `settingSources: ['user']` handles actual server loading.
   - Use `process.env.CLAUDE_CONFIG_DIR` (set by host-runner to `${HOME}/.claude`), falling back to `path.join(process.env.HOME || '', '.claude')`
   - Read `settings.json` (plain JSON, not JSONC -- no strip-json-comments needed)
   - Extract `Object.keys(settings.mcpServers)` if the field exists
   - Return empty array on any error (file not found, parse error, no mcpServers field) -- never throw
   - Log a warning on parse errors (not on file-not-found, which is normal)

2. `logMcpServerSources(configNames: string[], globalNames: string[], currentMode: string)`: Logs MCP server sources in separate sections.
   - Compute `overriddenNames`: global server names that also appear in configNames (config takes precedence)
   - Log format (using existing `log()` function):
     ```
     --- MCP Server Sources ---
       Config (nanoclaw.config.jsonc): server-a, server-b
       Global (~/.claude/settings.json): server-c, server-d
       Overridden by config: server-e
     ```
   - If a global server name is "nanoclaw", exclude it from the global list (reserved name)
   - If no config servers and no global servers, log: `  No additional MCP servers configured`
   - Only show the "Overridden by config" line if there are overridden names

Add required imports at the top: `import fs from 'fs'` and `import path from 'path'` (these are Node.js built-ins, already available in the agent-runner environment).

Do NOT modify any existing functions (filterMcpServersByMode, translateToSdkFormat). Only add new exports.
  </action>
  <verify>
Run `npx tsc --noEmit --project container/agent-runner/tsconfig.json` -- should compile with no errors.
Verify the two new functions are exported by checking the file.
  </verify>
  <done>
mcp-filter.ts exports readGlobalMcpServerNames() and logMcpServerSources(). TypeScript compiles cleanly. Existing functions unchanged.
  </done>
</task>

<task type="auto">
  <name>Task 2: Wire global inheritance logging and health status into agent-runner</name>
  <files>container/agent-runner/src/index.ts</files>
  <action>
Modify agent-runner index.ts to add global MCP server source logging and health status reporting from the SDK init message.

**Import changes:**
Add `readGlobalMcpServerNames` and `logMcpServerSources` to the existing import from `./mcp-filter.js`.

**Global server reading (after the existing MCP filtering block, around line 338):**
After the existing config MCP server filtering block and before queryOptions construction:
- Read global server names ONLY for main group in host mode: `const globalServerNames = (isMain && NANOCLAW_MODE === 'host') ? readGlobalMcpServerNames() : [];`
- Call `logMcpServerSources(Object.keys(configMcpServers), globalServerNames, NANOCLAW_MODE)` to log the separate source sections.
- This replaces the existing inline `log('No additional MCP servers configured')` and `log('MCP servers active...')` messages. Remove those existing log lines from the config MCP server block and let `logMcpServerSources` handle all source logging. Keep the filtered-out server logging (the `for (const f of filtered)` loop) as-is since it provides mode-filtering detail.

**IMPORTANT -- settingSources stays unchanged:**
Do NOT modify the `settingSources` assignment (line 342-343). Keep `['project', 'user']` for main group and `['project']` for non-main. The SDK loads global MCP servers via settingSources; we read `~/.claude/settings.json` separately ONLY for logging visibility. Config servers passed in `mcpServers` query option take precedence over same-named servers loaded from settingSources (SDK behavior).

**Health status logging from init message:**
In the `runQuery` function's `for await` loop, expand the existing `init` message handler (currently just captures `newSessionId`). Add health status logging:
- Record `Date.now()` before the `query()` call (add `const queryStartMs = Date.now();` before the `for await` line)
- In the `init` handler, after logging the session ID:
  - Compute `const initMs = Date.now() - queryStartMs;`
  - Check `message.mcp_servers` (the `init` message's `mcp_servers: { name: string; status: string }[]` field)
  - If the array exists and has entries, log health status:
    ```
    --- MCP Server Health ({initMs}ms) ---
      [OK] server-name
      [FAIL] other-server: failed
      All 3 servers connected
    ```
    OR if failures:
    ```
      Warning: 1/3 MCP servers not connected
    ```
  - Use `server.status === 'connected'` for OK, anything else is a failure. Log the status string for non-connected servers (e.g., `[FAIL] name: failed`, `[PENDING] name: pending`).
  - Status label: `'connected'` -> `'OK'`, otherwise uppercase the status string (e.g., `'FAIL'`, `'PENDING'`, `'NEEDS-AUTH'`).

**Agent-runner rebuild:**
After making changes, run `npm run build:agent` to rebuild the agent-runner dist.
  </action>
  <verify>
1. Run `npx tsc --noEmit --project container/agent-runner/tsconfig.json` -- TypeScript compiles cleanly.
2. Run `npm run build:agent` -- agent-runner dist rebuilds successfully.
3. Visually inspect the init message handler to confirm it logs mcp_servers health status.
4. Verify settingSources is unchanged (still `['project', 'user']` for main, `['project']` for non-main).
  </verify>
  <done>
Agent-runner reads global MCP server names for main+host groups and logs config vs global sources separately. The init message handler logs per-server health status with timing. settingSources unchanged. Agent-runner builds cleanly.
  </done>
</task>

</tasks>

<verification>
1. TypeScript compilation: `npx tsc --noEmit --project container/agent-runner/tsconfig.json` passes
2. Build: `npm run build:agent` succeeds
3. Code inspection: readGlobalMcpServerNames() reads from CLAUDE_CONFIG_DIR/settings.json
4. Code inspection: logMcpServerSources() prints config and global servers in separate sections
5. Code inspection: init message handler logs mcp_servers with status labels and timing
6. Code inspection: settingSources unchanged (main: ['project', 'user'], non-main: ['project'])
7. Code inspection: Global server reading only for isMain && NANOCLAW_MODE === 'host'
</verification>

<success_criteria>
- mcp-filter.ts exports readGlobalMcpServerNames() and logMcpServerSources()
- agent-runner index.ts calls both functions at appropriate points
- SDK init message mcp_servers are logged with OK/FAIL labels and timing
- settingSources are NOT modified (SDK handles actual loading)
- Global inheritance is main-group-only in host mode
- Config servers take precedence on name collision (documented in logs as "overridden")
- Both TypeScript compilation and build:agent succeed
</success_criteria>

<output>
After completion, create `.planning/phases/07-mcp-inheritance-and-health-checks/07-01-SUMMARY.md`
</output>
