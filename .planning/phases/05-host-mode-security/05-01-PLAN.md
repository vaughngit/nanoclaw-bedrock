---
phase: 05-host-mode-security
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/config-loader.ts
  - src/container-runner.ts
  - nanoclaw.config.jsonc
autonomous: true

must_haves:
  truths:
    - "Config with hostSecurity section parses and validates correctly"
    - "Config with invalid hostSecurity fields produces actionable Zod error"
    - "Config without hostSecurity section continues to work (backward compatible)"
    - "ContainerInput type includes optional security field for agent-runner consumption"
    - "Config template documents all hostSecurity fields with inline comments"
  artifacts:
    - path: "src/config-loader.ts"
      provides: "HostSecurity Zod schema, expanded NanoClawConfig type"
      contains: "hostSecurity"
    - path: "src/container-runner.ts"
      provides: "Extended ContainerInput with security field"
      contains: "security?"
    - path: "nanoclaw.config.jsonc"
      provides: "Uncommented hostSecurity section with documentation"
      contains: "hostSecurity"
  key_links:
    - from: "src/config-loader.ts"
      to: "nanoclaw.config.jsonc"
      via: "Zod schema validates hostSecurity section from config file"
      pattern: "hostSecurity"
    - from: "src/container-runner.ts"
      to: "container/agent-runner/src/index.ts"
      via: "ContainerInput.security flows from host to agent-runner via stdin"
      pattern: "security\\?"
---

<objective>
Add the hostSecurity configuration schema to the config loader, uncomment the hostSecurity section in the config template, and extend ContainerInput with a security field so host-runner can pass security config to agent-runner via stdin.

Purpose: Establish the configuration foundation that Plans 02 and 03 consume -- security config must be loadable and passable before the runner and agent-runner can use it.
Output: Extended config schema, updated config template, extended ContainerInput type.
</objective>

<execution_context>
@/Users/alvin/.claude/get-shit-done/workflows/execute-plan.md
@/Users/alvin/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-host-mode-security/05-RESEARCH.md
@src/config-loader.ts
@src/container-runner.ts
@nanoclaw.config.jsonc
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add hostSecurity Zod schema to config-loader</name>
  <files>src/config-loader.ts</files>
  <action>
Add a `HostSecuritySchema` using z.strictObject with these fields:
- `sandbox`: z.boolean().default(true) -- enables macOS Seatbelt sandbox for non-main groups
- `allowedTools`: z.array(z.string()).optional() -- positive allowlist of tools for non-main groups. When undefined, no restriction (full tool set). When provided, only these tools are available. Must validate: if array is present, it must be non-empty (use z.array(z.string()).min(1).optional()) to prevent users from accidentally disabling all tools.

Add this as an optional field to NanoClawConfigSchema:
```typescript
hostSecurity: HostSecuritySchema.optional(),
```

This keeps backward compatibility -- existing configs without hostSecurity still parse correctly.

The `permissionMode` for non-main groups is NOT configurable (always 'default' for non-main). This is a safety invariant, not a user choice. Do not add it to the config schema.

Export the inner type for use by other modules:
```typescript
export type HostSecurityConfig = z.output<typeof HostSecuritySchema>;
```

Update the startup log line to include hostSecurity status when present:
```typescript
process.stderr.write(`[config] Config loaded: executionMode=${config.executionMode}${config.hostSecurity ? `, sandbox=${config.hostSecurity.sandbox}` : ''}\n`);
```
  </action>
  <verify>
Add a temporary test by running the app with the current config (which has executionMode: "host"). The startup log should show the config loaded message. If hostSecurity is not in the file yet, it should parse fine with `hostSecurity: undefined`.
  </verify>
  <done>
NanoClawConfigSchema includes optional hostSecurity field with sandbox (boolean, default true) and allowedTools (optional string array, min 1 when present). Config loads correctly with and without hostSecurity section. HostSecurityConfig type is exported.
  </done>
</task>

<task type="auto">
  <name>Task 2: Extend ContainerInput with security field and update config template</name>
  <files>src/container-runner.ts, nanoclaw.config.jsonc</files>
  <action>
**ContainerInput extension (src/container-runner.ts):**

Add an optional `security` field to the `ContainerInput` interface:
```typescript
export interface ContainerInput {
  prompt: string;
  sessionId?: string;
  groupFolder: string;
  chatJid: string;
  isMain: boolean;
  isScheduledTask?: boolean;
  /** Security config for host mode agent (undefined = no restrictions, i.e. main group) */
  security?: {
    sandbox: boolean;
    allowedTools?: string[];
  };
}
```

This is backward compatible -- container-runner.ts does not use this field. The agent-runner reads it from stdin.

**Config template (nanoclaw.config.jsonc):**

Uncomment the hostSecurity section. Replace the commented-out block with a live, populated section. The section should be present and active since the user is already running in host mode.

Replace the current commented-out hostSecurity block (lines ~89-119) with:

```jsonc
  // ─── Host Mode Security ───────────────────────────────────────────
  //
  // When executionMode is "host", these settings control what NON-MAIN
  // group agents can do. The main group is always exempt (unsandboxed,
  // full tool access, bypassPermissions).
  //
  // Container mode ignores these entirely (containers have their own
  // isolation via Linux VMs).
  //
  "hostSecurity": {

    // ── Sandbox ──
    // macOS Seatbelt sandbox restricts Bash tool filesystem/network access
    // for non-main groups. Powered by the Claude Agent SDK's sandbox option.
    //
    //   true  (default) - Bash commands run in Seatbelt sandbox
    //   false           - No sandbox, full macOS access (use with caution)
    //
    // The sandbox only affects the Bash tool. Read/Write/Edit/Glob/Grep
    // are controlled by the SDK's permission mode (non-main groups use
    // 'default' mode, which prompts before destructive operations).
    //
    // To disable sandbox for a specific group, use per-group overrides
    // in registered_groups.json (Phase 8).
    //
    "sandbox": true

    // ── Allowed Tools ──
    // Positive allowlist of tools available to non-main group agents.
    // When omitted or commented out: full Claude Code tool set (no restriction).
    // When present: ONLY these tools are available (SDK `tools` option).
    //
    // NanoClaw MCP tools (mcp__nanoclaw__*) are ALWAYS available regardless
    // of this setting -- they're needed for IPC communication.
    //
    // WARNING: An empty array [] disables ALL built-in tools, making the
    // agent non-functional. The minimum useful set is ["Read", "Grep"].
    //
    // Available tools:
    //   "Bash"       - Execute shell commands (sandboxed if sandbox: true)
    //   "Read"       - Read file contents
    //   "Write"      - Create/overwrite files
    //   "Edit"       - Edit existing files (find & replace)
    //   "Glob"       - Find files by pattern
    //   "Grep"       - Search file contents
    //   "WebSearch"  - Search the web
    //   "WebFetch"   - Fetch URL content
    //
    // UNCOMMENT to restrict tools (default: all tools available):
    // "allowedTools": [
    //   "Bash", "Read", "Write", "Edit", "Glob", "Grep",
    //   "WebSearch", "WebFetch"
    // ]

  },
```

Note: No trailing comma after `"sandbox": true` since allowedTools is commented out. If allowedTools were uncommented, add a comma after `"sandbox": true,`.
  </action>
  <verify>
Run `npm run build` to ensure TypeScript compiles. Run the app briefly with `npm run dev` and confirm it starts with the new hostSecurity section parsed correctly (startup log should show `sandbox=true`).
  </verify>
  <done>
ContainerInput has optional security field. Config template has live hostSecurity section with sandbox: true and documented allowedTools (commented out). App starts and parses the new config section correctly.
  </done>
</task>

</tasks>

<verification>
1. `npm run build` succeeds with no type errors
2. App starts with current config and logs `executionMode=host, sandbox=true`
3. Removing hostSecurity from config still starts correctly (backward compatible)
4. Adding `"allowedTools": []` to hostSecurity produces a Zod validation error (min 1)
5. Adding an unknown field like `"snadbox": true` produces unrecognized keys error
</verification>

<success_criteria>
- Config loader validates hostSecurity with sandbox boolean and optional allowedTools array
- ContainerInput type includes security field for agent-runner communication
- Config template has live, documented hostSecurity section
- All changes are backward compatible
</success_criteria>

<output>
After completion, create `.planning/phases/05-host-mode-security/05-01-SUMMARY.md`
</output>
