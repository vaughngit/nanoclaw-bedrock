---
phase: 02-config-template-and-env-expansion
plan: 01
type: execute
wave: 1
depends_on: []
files_modified: [nanoclaw.config.jsonc, src/config-loader.ts]
autonomous: true

must_haves:
  truths:
    - "A nanoclaw.config.jsonc file exists at project root with inline JSONC comments explaining executionMode, MCP servers, host security, and per-group overrides"
    - "Config values containing ${VAR} are expanded from environment variables before Zod validation"
    - "Config values containing ${VAR:-default} use the default when the env var is unset or empty"
    - "Unresolved env vars (no value, no default) produce a warning on stderr before validation"
    - "MCP server args and paths with env var references would resolve correctly (verified via expandEnvVars unit behavior)"
    - "Backward compatibility preserved: app starts identically when config file is absent or uses no env vars"
  artifacts:
    - path: "nanoclaw.config.jsonc"
      provides: "Self-documenting config template with all fields documented via comments"
      contains: "executionMode"
    - path: "src/config-loader.ts"
      provides: "Env var expansion step in the load pipeline"
      contains: "expandEnvVars"
  key_links:
    - from: "src/config-loader.ts"
      to: "nanoclaw.config.jsonc"
      via: "loadAndValidateConfig reads, strips comments, parses JSON, expands env vars, then validates"
      pattern: "expandEnvVars\\(data\\)"
    - from: "src/config-loader.ts expandEnvVars"
      to: "process.env"
      via: "regex replacement of ${VAR} and ${VAR:-default} patterns"
      pattern: "process\\.env\\[name\\]"
---

<objective>
Ship a self-documenting `nanoclaw.config.jsonc` template and add environment variable expansion (`${VAR}` and `${VAR:-default}`) to the config loader pipeline.

Purpose: Users get a rich, commented config file they can copy and customize, with env var interpolation for secrets and paths -- completing the config foundation before later phases add host runner, MCP servers, and security settings.

Output: `nanoclaw.config.jsonc` at project root (template), modified `src/config-loader.ts` with `expandEnvVars()` step in the load pipeline.
</objective>

<execution_context>
@/Users/alvin/.claude/get-shit-done/workflows/execute-plan.md
@/Users/alvin/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-config-template-and-env-expansion/02-RESEARCH.md
@.planning/phases/01-config-loader/01-01-SUMMARY.md
@.planning/phases/01-config-loader/01-02-SUMMARY.md
@src/config-loader.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create nanoclaw.config.jsonc template and add env expansion to config-loader</name>
  <files>nanoclaw.config.jsonc, src/config-loader.ts</files>
  <action>
**Part A: Create `nanoclaw.config.jsonc` at project root.**

This is the self-documenting config template. It uses JSONC format (comments + trailing commas). Structure it with these sections, using `//` line comments and visual separators (`═══` and `───`):

1. **Header block** (top): File purpose, JSONC format note, secrets-in-.env reminder, env var syntax explanation (`${VAR}` and `${VAR:-default}`), note about uncommenting sections as features are enabled.

2. **Execution Mode** (ACTIVE -- uncommented JSON):
   - `"executionMode": "container"` -- the only active field for Phase 2
   - Detailed comments above explaining `"container"` (safe default, isolated Linux VMs, can't access host tools) vs `"host"` (direct macOS, full access, requires trust)
   - Trade-off summary in comments

3. **MCP Servers** (COMMENTED OUT -- requires Phase 6):
   - Full commented-out `"mcpServers"` object with three example servers:
     - stdio server with env var in `env` block (github example with `${GITHUB_TOKEN}`)
     - stdio server with path expansion in `args` (filesystem example with `${HOME}/projects`)
     - HTTP/SSE remote server with env var in headers
   - Comments explaining server types (stdio, http, sse), `modes` array, and env var expansion in args/env
   - Note: "UNCOMMENT when ready (requires Phase 6)"

4. **Host Mode Security** (COMMENTED OUT -- requires Phase 5):
   - Commented-out `"hostSecurity"` object with `sandbox` and `allowedTools` fields
   - Comments explaining what each setting does, that container mode ignores these
   - Note: "UNCOMMENT when ready (requires Phase 5)"

5. **Per-Group Overrides** (COMMENTS ONLY -- no fields needed):
   - Comment block explaining per-group overrides are in the database (registered_groups), not config
   - Points to Phase 8

Use the exact template structure from the research doc's "Config Template Structure (Complete)" section as the reference. The template must have ONLY `"executionMode"` as an actual JSON field -- everything else is commented out. This is critical because `z.strictObject()` rejects unknown keys.

**Part B: Add `expandEnvVars()` to `src/config-loader.ts`.**

Add the env expansion function and integrate it into the existing load pipeline. Specific changes:

1. Add the `expandEnvVars()` function ABOVE `loadAndValidateConfig()`:
   - Regex: `/\$\{([A-Za-z_][A-Za-z0-9_]*)(?::-([^}]*))?}/g`
   - Recursively walks parsed JSON: strings get regex replacement, arrays mapped, objects walk values (not keys), primitives pass through
   - For `${VAR:-default}`: use default when env var is unset OR empty (bash convention: `envVal !== undefined && envVal !== ''`)
   - Track unresolved vars (no env value AND no default) in a module-level array
   - Return empty string for unresolved vars (standard behavior)

2. Add an `unresolvedVars` array and tracking:
   - Declare `let unresolvedVars: string[] = [];` before the function
   - In the replacement callback, push var name to `unresolvedVars` when there's no env value and no default
   - Reset `unresolvedVars = []` at the start of `loadAndValidateConfig()` (in case of future re-calls)

3. Insert expansion into the pipeline in `loadAndValidateConfig()`:
   - After `data = JSON.parse(stripped)` (line ~147 area)
   - Before `NanoClawConfigSchema.safeParse(data)` (line ~158 area)
   - Add: `data = expandEnvVars(data);`
   - After expansion, before validation: if `unresolvedVars.length > 0`, write warning to stderr: `[config] Warning: unresolved env vars: ${unresolvedVars.join(', ')}\n`

4. DO NOT change the existing error handling, Zod schema, or any other part of the file. The env expansion slots cleanly between JSON.parse and safeParse.

5. DO NOT add `expandEnvVars` to the module exports. It's an internal function.
  </action>
  <verify>
1. Template loads without errors: `cd /Users/alvin/dev/nanoclaw && cp nanoclaw.config.jsonc /tmp/test-config.jsonc && node -e "const s = require('strip-json-comments').default; const fs = require('fs'); const raw = fs.readFileSync('nanoclaw.config.jsonc','utf8'); const j = JSON.parse(s(raw, {trailingCommas:true})); console.log(JSON.stringify(j));"` -- should output `{"executionMode":"container"}`
2. Run `npm run dev` briefly (Ctrl+C after config loads) -- should see `[config] Config loaded: executionMode=container` with no errors
3. Test env expansion: Create a temporary config with `"executionMode": "${TEST_MODE:-container}"`, run with `TEST_MODE=host` and verify it loads as host mode; run without TEST_MODE and verify it loads as container
4. Test unresolved var warning: Config with `"executionMode": "${MISSING_VAR}"` should show warning about unresolved var, then Zod validation error about invalid enum value
5. TypeScript compiles: `npx tsc --noEmit` passes (or existing build command)
  </verify>
  <done>
- `nanoclaw.config.jsonc` exists at project root with inline comments for all sections (execution mode, MCP servers, host security, per-group overrides)
- Only `executionMode` is an actual JSON field; all future fields are commented out
- `expandEnvVars()` function exists in config-loader.ts
- `${VAR}` expansion works: env var value replaces the reference
- `${VAR:-default}` works: default used when var is unset or empty
- Unresolved vars produce stderr warning before validation
- Backward compat: absent config file still works, config without env vars still works
  </done>
</task>

</tasks>

<verification>
1. **Template content**: `nanoclaw.config.jsonc` contains sections for execution mode (active), MCP servers (commented), host security (commented), per-group overrides (comments only)
2. **Template parseable**: After stripping comments, only `{"executionMode":"container"}` remains
3. **Env expansion basic**: `${HOME}` in a config value resolves to the actual home directory
4. **Env expansion default**: `${UNSET_VAR:-fallback}` resolves to `"fallback"`
5. **Env expansion empty**: `${EMPTY_VAR:-fallback}` where EMPTY_VAR="" resolves to `"fallback"` (bash convention)
6. **Env expansion nested objects**: `${VAR}` in deeply nested config values (like MCP server env blocks) resolves correctly
7. **Env expansion arrays**: `${VAR}` in array elements resolves correctly
8. **Unresolved warning**: `${MISSING}` with no default triggers stderr warning naming the variable
9. **Non-strings untouched**: Numbers, booleans, null pass through expandEnvVars unchanged
10. **Backward compat**: App starts with no config file, app starts with config file containing no env vars
11. **TypeScript compiles**: No type errors introduced
</verification>

<success_criteria>
- `nanoclaw.config.jsonc` ships as a self-documenting template with inline comments for every current and future config section
- `expandEnvVars()` is integrated into the config loader pipeline between JSON.parse and Zod validation
- `${VAR}` and `${VAR:-default}` syntax works in all string config values
- Unresolved env vars produce a clear warning on stderr
- All Phase 2 success criteria from ROADMAP.md are met
</success_criteria>

<output>
After completion, create `.planning/phases/02-config-template-and-env-expansion/02-01-SUMMARY.md`
</output>
