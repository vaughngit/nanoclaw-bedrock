---
phase: 03-agent-runner-path-flexibility
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - container/agent-runner/src/index.ts
  - container/agent-runner/src/ipc-mcp.ts
  - nanoclaw.config.jsonc
autonomous: true

must_haves:
  truths:
    - "Agent-runner reads NANOCLAW_GROUP_DIR, NANOCLAW_GLOBAL_DIR, NANOCLAW_IPC_DIR, and NANOCLAW_MODE from environment, falling back to /workspace/* defaults when unset"
    - "Container mode works identically after the refactor -- no env vars set means all paths resolve to /workspace/* defaults"
    - "IPC MCP tool uses configurable IPC directory via parameter injection, not hardcoded /workspace/ipc"
    - "Agent-runner TypeScript compiles without errors"
    - "Container image rebuilds successfully with refactored agent-runner"
  artifacts:
    - path: "container/agent-runner/src/index.ts"
      provides: "Path-configurable agent runner with resolvePathVar() helper, GROUP_DIR/GLOBAL_DIR constants, mode-driven settingSources, auto-directory creation"
      contains: "resolvePathVar"
    - path: "container/agent-runner/src/ipc-mcp.ts"
      provides: "IPC MCP server with injected ipcDir parameter instead of hardcoded IPC_DIR"
      contains: "ipcDir"
    - path: "nanoclaw.config.jsonc"
      provides: "Documented path env vars section explaining NANOCLAW_GROUP_DIR, NANOCLAW_GLOBAL_DIR, NANOCLAW_IPC_DIR, NANOCLAW_MODE, CLAUDE_CONFIG_DIR"
      contains: "NANOCLAW_GROUP_DIR"
  key_links:
    - from: "container/agent-runner/src/index.ts"
      to: "container/agent-runner/src/ipc-mcp.ts"
      via: "ipcDir parameter passed to createIpcMcp()"
      pattern: "createIpcMcp.*ipcDir"
    - from: "container/agent-runner/src/index.ts"
      to: "process.env.NANOCLAW_GROUP_DIR"
      via: "resolvePathVar() helper"
      pattern: "resolvePathVar.*NANOCLAW_GROUP_DIR"
---

<objective>
Replace all hardcoded `/workspace/*` paths in the agent-runner with environment-variable-backed constants that fall back to the current defaults. Make the IPC directory injectable. Add mode-driven `settingSources`. Document the path env vars in the config template. Rebuild the container image and verify backward compatibility.

Purpose: Enable the same agent-runner codebase to run inside containers (defaults) or on the host (Phase 4 sets env vars). This is the prerequisite for Phase 4's host runner.

Output: Refactored agent-runner code, updated config documentation, rebuilt container image.
</objective>

<execution_context>
@/Users/alvin/.claude/get-shit-done/workflows/execute-plan.md
@/Users/alvin/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-agent-runner-path-flexibility/03-RESEARCH.md
@container/agent-runner/src/index.ts
@container/agent-runner/src/ipc-mcp.ts
@nanoclaw.config.jsonc
</context>

<tasks>

<task type="auto">
  <name>Task 1: Make agent-runner paths environment-configurable</name>
  <files>
    container/agent-runner/src/index.ts
    container/agent-runner/src/ipc-mcp.ts
  </files>
  <action>
Refactor the two agent-runner source files to replace all hardcoded `/workspace/*` paths with environment-variable-backed constants. The research identified exactly 5 hardcoded paths. Follow these steps:

**In `container/agent-runner/src/index.ts`:**

1. Add a `resolvePathVar()` helper near the top (after imports, before interfaces). This function reads an env var, validates it is absolute (using `path.isAbsolute()`), falls back to default if unset or relative, and logs a warning if relative:

```typescript
function resolvePathVar(envVar: string, defaultPath: string): string {
  const value = process.env[envVar];
  if (!value) return defaultPath;
  if (!path.isAbsolute(value)) {
    log(`Warning: ${envVar}="${value}" is not absolute, using default: ${defaultPath}`);
    return defaultPath;
  }
  return value;
}
```

2. Add path constants after the helper (before the `log()` function -- move the `log()` function above `resolvePathVar()` since it uses `log()`):

```typescript
const GROUP_DIR = resolvePathVar('NANOCLAW_GROUP_DIR', '/workspace/group');
const GLOBAL_DIR = resolvePathVar('NANOCLAW_GLOBAL_DIR', '/workspace/global');
const IPC_DIR = resolvePathVar('NANOCLAW_IPC_DIR', '/workspace/ipc');
const NANOCLAW_MODE = process.env.NANOCLAW_MODE || 'container';
```

3. Add mode/path logging (only in non-container mode):

```typescript
if (NANOCLAW_MODE !== 'container') {
  log(`Mode: ${NANOCLAW_MODE}`);
  log(`Group dir: ${GROUP_DIR}`);
  log(`Global dir: ${GLOBAL_DIR}`);
  log(`IPC dir: ${IPC_DIR}`);
}
```

4. Replace hardcoded path on line 136 (`const conversationsDir = '/workspace/group/conversations'`) with:
```typescript
const conversationsDir = path.join(GROUP_DIR, 'conversations');
```

5. Replace hardcoded path on line 261 (`const globalClaudeMdPath = '/workspace/global/CLAUDE.md'`) with:
```typescript
const globalClaudeMdPath = path.join(GLOBAL_DIR, 'CLAUDE.md');
```

6. Replace hardcoded `cwd` on line 273 (`cwd: '/workspace/group'`) with:
```typescript
cwd: GROUP_DIR,
```

7. Add mode-driven `settingSources` before the `query()` call:
```typescript
const settingSources: ('project' | 'user')[] =
  NANOCLAW_MODE === 'host' ? ['project', 'user'] : ['project'];
```
Then replace `settingSources: ['project']` on line 286 with `settingSources,`.

8. Add auto-directory creation at the start of `main()`, after parsing stdin input but before the `query()` call:
```typescript
fs.mkdirSync(GROUP_DIR, { recursive: true });
```

9. Pass `ipcDir: IPC_DIR` to `createIpcMcp()`:
```typescript
const ipcMcp = createIpcMcp({
  chatJid: input.chatJid,
  groupFolder: input.groupFolder,
  isMain: input.isMain,
  ipcDir: IPC_DIR,
});
```

**In `container/agent-runner/src/ipc-mcp.ts`:**

1. Add `ipcDir: string` to the `IpcMcpContext` interface.

2. Remove the hardcoded module-level constants:
```typescript
// REMOVE these three lines:
const IPC_DIR = '/workspace/ipc';
const MESSAGES_DIR = path.join(IPC_DIR, 'messages');
const TASKS_DIR = path.join(IPC_DIR, 'tasks');
```

3. Inside `createIpcMcp()`, derive `MESSAGES_DIR` and `TASKS_DIR` from the injected `ipcDir`:
```typescript
const { chatJid, groupFolder, isMain, ipcDir } = ctx;
const MESSAGES_DIR = path.join(ipcDir, 'messages');
const TASKS_DIR = path.join(ipcDir, 'tasks');
```

4. The `list_tasks` tool reads `path.join(IPC_DIR, 'current_tasks.json')` -- update to use `ipcDir`:
```typescript
const tasksFile = path.join(ipcDir, 'current_tasks.json');
```

5. For the tool description string on line 120 containing `/workspace/project/data/registered_groups.json`: make it path-agnostic by changing to `"look up JIDs in the registered groups data file (available_groups.json in the IPC directory)"`. This avoids a hardcoded path that will be wrong in host mode.

**Important constraints:**
- Do NOT modify the Dockerfile or entrypoint.sh
- Do NOT add per-group subdirectory logic inside the agent-runner
- Do NOT change the agent-runner's package.json or add dependencies
- All fallback defaults must be `/workspace/*` paths (backward compatibility)
  </action>
  <verify>
Run TypeScript compilation check:
```bash
cd container/agent-runner && npx tsc --noEmit
```
Must produce zero errors.

Grep for remaining hardcoded `/workspace/` paths in the agent-runner source:
```bash
grep -n '/workspace/' container/agent-runner/src/index.ts container/agent-runner/src/ipc-mcp.ts
```
The only remaining `/workspace/` references should be in the default fallback values inside `resolvePathVar()` calls (i.e., the string literals used as defaults).
  </verify>
  <done>
All 5 hardcoded paths replaced with env-var-backed constants. `resolvePathVar()` helper validates absolute paths. IPC directory injected via parameter. Mode-driven `settingSources` added. Auto-directory creation added. TypeScript compiles cleanly.
  </done>
</task>

<task type="auto">
  <name>Task 2: Document path env vars in config and rebuild container</name>
  <files>
    nanoclaw.config.jsonc
  </files>
  <action>
Two deliverables: config documentation and container rebuild.

**1. Add path env var documentation to `nanoclaw.config.jsonc`:**

Add a commented section AFTER the "Per-Group Overrides" section (before the closing `}`) documenting the path environment variables. This is reference documentation only -- these are not config fields, they are env vars set by the host runner.

```jsonc
  // ─── Path Environment Variables (Host Mode) ────────────────────
  //
  // When executionMode is "host", the host runner sets these env vars
  // on each agent-runner subprocess. You do NOT set these manually.
  //
  // These are documented here for reference and troubleshooting:
  //
  //   NANOCLAW_GROUP_DIR   - Agent working directory (per-group files)
  //   NANOCLAW_GLOBAL_DIR  - Shared global memory directory
  //   NANOCLAW_IPC_DIR     - IPC file exchange directory
  //   NANOCLAW_MODE        - "container" or "host" (affects settings sources)
  //   CLAUDE_CONFIG_DIR    - Claude session storage (SDK variable)
  //
  // In container mode, these are unset and defaults apply (/workspace/*).
  // In host mode, the runner resolves them to absolute macOS paths.
  // If a path doesn't exist, the agent-runner creates it automatically.
```

Place this BEFORE the final closing `}` and after the per-group overrides comment block.

**2. Rebuild the container image:**

Run the container build script:
```bash
./container/build.sh
```

This compiles the agent-runner TypeScript inside the Docker build and packages the container image. It must complete without errors.

**3. Verify backward compatibility:**

After rebuild, confirm the container image exists and has a recent timestamp:
```bash
container images ls | grep nanoclaw
```

Optionally, if the container runtime is available, verify the container starts:
```bash
echo '{"prompt":"Say hello","groupFolder":"test","chatJid":"test@g.us","isMain":false}' | timeout 30 container run --rm -i nanoclaw-agent:latest 2>/dev/null || echo "Container runtime test skipped (requires auth)"
```
Note: The container may fail due to missing Bedrock auth, which is expected. The key verification is that the container image BUILDS successfully (TypeScript compiles, image packages).
  </action>
  <verify>
1. Config file contains the new comment section:
```bash
grep "NANOCLAW_GROUP_DIR" nanoclaw.config.jsonc
```

2. Container build succeeded:
```bash
container images ls | grep nanoclaw
```
Image should exist with today's date.

3. Agent-runner TypeScript compiles locally:
```bash
cd container/agent-runner && npx tsc --noEmit
```
  </verify>
  <done>
Path env vars documented in nanoclaw.config.jsonc. Container image rebuilt successfully with refactored agent-runner. TypeScript compilation verified.
  </done>
</task>

</tasks>

<verification>
Phase-level verification checks:

1. **Env var fallback**: With NO `NANOCLAW_*` env vars set, all paths resolve to `/workspace/*` defaults (grep for default values in code)
2. **TypeScript compilation**: `cd container/agent-runner && npx tsc --noEmit` passes with zero errors
3. **Container rebuild**: `./container/build.sh` completes successfully
4. **No hardcoded paths remain**: `grep -n '/workspace/' container/agent-runner/src/*.ts` shows only default fallback strings in `resolvePathVar()` calls
5. **IPC injection**: `grep 'ipcDir' container/agent-runner/src/ipc-mcp.ts` shows the parameter in the interface and destructured in `createIpcMcp()`
6. **Config documentation**: `grep 'NANOCLAW_GROUP_DIR' nanoclaw.config.jsonc` shows the env var reference in comments
7. **settingSources**: `grep 'settingSources' container/agent-runner/src/index.ts` shows mode-driven selection
</verification>

<success_criteria>
1. Agent-runner reads NANOCLAW_IPC_DIR, NANOCLAW_GROUP_DIR, NANOCLAW_GLOBAL_DIR, and NANOCLAW_MODE from environment, falling back to /workspace/* defaults
2. Container mode continues to work identically after the refactor (same behavior when env vars are unset)
3. IPC MCP tool uses configurable IPC directory instead of hardcoded /workspace/ipc
4. Container image rebuilds successfully with the refactored agent-runner
5. Path env vars are documented in nanoclaw.config.jsonc for reference
</success_criteria>

<output>
After completion, create `.planning/phases/03-agent-runner-path-flexibility/03-01-SUMMARY.md`
</output>
