---
phase: 08-per-group-overrides-and-integration
plan: 02
type: execute
wave: 2
depends_on: ["08-01"]
files_modified:
  - container/agent-runner/src/ipc-mcp.ts
  - nanoclaw.config.jsonc
  - src/index.ts
autonomous: true

must_haves:
  truths:
    - "Main group can ask for system health and get execution mode, MCP servers, and security config for all groups"
    - "register_group IPC tool accepts optional executionMode parameter"
    - "Config template documents per-group override behavior with clear examples"
    - "Health command is restricted to main group only"
  artifacts:
    - path: "container/agent-runner/src/ipc-mcp.ts"
      provides: "system_health tool and register_group executionMode param"
      contains: "system_health"
    - path: "nanoclaw.config.jsonc"
      provides: "Updated per-group overrides documentation"
      contains: "executionMode"
    - path: "src/index.ts"
      provides: "system_health IPC handler writing health snapshot"
      contains: "system_health"
  key_links:
    - from: "container/agent-runner/src/ipc-mcp.ts"
      to: "src/index.ts"
      via: "system_health IPC file triggers health snapshot write"
      pattern: "system_health"
    - from: "container/agent-runner/src/ipc-mcp.ts"
      to: "src/types.ts"
      via: "register_group passes executionMode field"
      pattern: "executionMode"
---

<objective>
Add health check IPC tool for main group, update register_group tool with executionMode param, and finalize config template documentation for per-group overrides.

Purpose: This completes Phase 8 by giving the operator (main group) visibility into the running system configuration, enabling groups to be registered with a specific execution mode via IPC, and ensuring the config template clearly documents how per-group overrides work.

Output: system_health IPC tool (main-only) reports execution mode, MCP servers, and security config per group. register_group tool gains optional executionMode parameter. Config template documents per-group override behavior.
</objective>

<execution_context>
@/Users/alvin/.claude/get-shit-done/workflows/execute-plan.md
@/Users/alvin/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-per-group-overrides-and-integration/08-01-PLAN.md
@container/agent-runner/src/ipc-mcp.ts
@src/index.ts
@nanoclaw.config.jsonc
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add system_health IPC tool and update register_group with executionMode</name>
  <files>container/agent-runner/src/ipc-mcp.ts, src/index.ts</files>
  <action>
**container/agent-runner/src/ipc-mcp.ts -- system_health tool:**

Add a new `system_health` tool to the tools array in `createIpcMcp()`. This tool is main-only and writes a request to the tasks IPC directory. The host process responds by writing a snapshot file.

```typescript
tool(
  'system_health',
  'Get system health information including execution mode, active MCP servers, and security config for all groups. Main group only.',
  {},
  async () => {
    if (!isMain) {
      return {
        content: [{ type: 'text', text: 'System health is only available to the main group.' }],
        isError: true
      };
    }

    // Write health check request to tasks IPC
    const data = {
      type: 'system_health',
      groupFolder,
      timestamp: new Date().toISOString()
    };

    writeIpcFile(TASKS_DIR, ipcDir, data);

    // Read the health snapshot that the host process maintains
    const healthFile = path.join(ipcDir, 'system_health.json');

    // Wait briefly for host to process (it runs on IPC_POLL_INTERVAL)
    await new Promise(resolve => setTimeout(resolve, 2000));

    try {
      if (fs.existsSync(healthFile)) {
        const health = JSON.parse(fs.readFileSync(healthFile, 'utf-8'));
        return {
          content: [{
            type: 'text',
            text: JSON.stringify(health, null, 2)
          }]
        };
      }
      return {
        content: [{
          type: 'text',
          text: 'Health snapshot not yet available. The host process writes it on the next IPC poll cycle. Try again in a few seconds.'
        }]
      };
    } catch (err) {
      return {
        content: [{
          type: 'text',
          text: `Error reading health snapshot: ${err instanceof Error ? err.message : String(err)}`
        }]
      };
    }
  }
),
```

**container/agent-runner/src/ipc-mcp.ts -- register_group executionMode:**

Update the `register_group` tool's Zod schema to accept an optional `executionMode` parameter:

```typescript
// Add to the schema object for register_group:
executionMode: z.enum(['container', 'host']).optional().describe(
  'Execution mode override for this group. Omit to inherit the global setting.'
),
```

And pass it through in the IPC data:
```typescript
const data = {
  type: 'register_group',
  jid: args.jid,
  name: args.name,
  folder: args.folder,
  trigger: args.trigger,
  executionMode: args.executionMode,
  timestamp: new Date().toISOString()
};
```

**src/index.ts -- system_health IPC handler:**

Add a new case to the `processTaskIpc()` switch statement. Insert it after the `register_group` case `break;` (line 755) and before the `default:` case (line 757). The surrounding context looks like:

```typescript
      // ... end of register_group case ...
      break;                    // <-- line 755

    // INSERT system_health case HERE

    default:                    // <-- line 757
      logger.warn({ type: data.type }, 'Unknown IPC task type');
  }
```

Also add `'system_health'` to the `data` type annotation in `processTaskIpc` (around line 541-557). No extra fields are needed beyond `type` and `groupFolder` (which is already in the annotation).

The new case to insert:

```typescript
case 'system_health':
  if (!isMain) {
    logger.warn({ sourceGroup }, 'Unauthorized system_health attempt blocked');
    break;
  }

  try {
    const groups = Object.entries(registeredGroups);
    const healthData = {
      timestamp: new Date().toISOString(),
      globalExecutionMode: config.executionMode,
      hostSecurity: config.hostSecurity ? {
        sandbox: config.hostSecurity.sandbox,
        tools: config.hostSecurity.tools ?? 'all (unrestricted)',
      } : null,
      mcpServers: Object.keys(config.mcpServers).length,
      groups: groups.map(([jid, g]) => ({
        name: g.name,
        folder: g.folder,
        jid,
        executionMode: resolveExecutionMode(g),
        override: g.executionMode ?? null,
      })),
    };

    const healthFile = path.join(DATA_DIR, 'ipc', sourceGroup, 'system_health.json');
    // Atomic write
    const tempPath = `${healthFile}.tmp`;
    fs.writeFileSync(tempPath, JSON.stringify(healthData, null, 2));
    fs.renameSync(tempPath, healthFile);

    logger.info({ sourceGroup }, 'System health snapshot written');
  } catch (err) {
    logger.error({ err, sourceGroup }, 'Failed to write system health snapshot');
  }
  break;
```

Add `system_health` to the `data` type annotation for `processTaskIpc` (it has no additional required fields beyond `type`).
  </action>
  <verify>
Run `npm run build && npm run build:agent` to verify both the host and agent-runner compile. Grep for `system_health` in ipc-mcp.ts and index.ts. Grep for `executionMode` in ipc-mcp.ts to confirm register_group update.
  </verify>
  <done>
system_health tool available in IPC MCP (main-only). Host process writes health snapshot on request with global mode, per-group modes, security config, and MCP server count. register_group tool accepts optional executionMode parameter.
  </done>
</task>

<task type="auto">
  <name>Task 2: Update config template documentation for per-group overrides</name>
  <files>nanoclaw.config.jsonc</files>
  <action>
Replace the existing "Per-Group Overrides" comment section in `nanoclaw.config.jsonc` with updated documentation that reflects the implemented behavior:

```jsonc
  // --- Per-Group Overrides ──────────────────────────────────────────
  //
  // Individual groups can override the global executionMode above.
  // Overrides are stored in the database (registered_groups), not here.
  //
  // HOW IT WORKS:
  //   1. Register a group with an executionMode override:
  //      Use the register_group IPC tool with executionMode: "host" or "container"
  //   2. Groups WITHOUT an executionMode inherit the global setting above
  //   3. Mode is resolved at message time (no restart needed after changes)
  //
  // EXAMPLES:
  //   Global: "container" + group override: "host"
  //     -> That group runs on macOS, all others in containers
  //
  //   Global: "host" + group override: "container"
  //     -> That group runs in a container, all others on macOS
  //
  // SAFETY:
  //   If ANY group uses host mode, "hostSecurity" above MUST be configured.
  //   Startup will block with a clear error if hostSecurity is missing.
  //
  // STARTUP BANNER:
  //   When host mode is active, startup prints a prominent banner
  //   showing which groups have macOS access and security settings.
```

Also update the hostSecurity section comment that references "Phase 8":
Replace the line:
```
    // To disable sandbox for a specific group, use per-group overrides
    // in registered_groups.json (Phase 8).
```
With:
```
    // Per-group overrides can set executionMode but sandbox/tools are global.
    // All non-main host-mode groups share the same security settings.
```
  </action>
  <verify>
Read nanoclaw.config.jsonc and verify the per-group overrides section contains "HOW IT WORKS", "EXAMPLES", and "SAFETY" subsections. Verify no reference to "Phase 8" remains in the file.
  </verify>
  <done>
Config template documents per-group override behavior with how-it-works explanation, examples, safety requirements, and startup banner description. Phase 8 reference removed.
  </done>
</task>

</tasks>

<verification>
1. `npm run build` passes with no TypeScript errors
2. `npm run build:agent` passes (agent-runner compiles with new tool)
3. Grep confirms `system_health` tool exists in ipc-mcp.ts
4. Grep confirms `system_health` case exists in index.ts processTaskIpc
5. Grep confirms `executionMode` parameter in register_group tool schema (ipc-mcp.ts)
6. Config template contains "HOW IT WORKS" documentation for per-group overrides
7. No remaining "Phase 8" references in nanoclaw.config.jsonc
</verification>

<success_criteria>
- system_health IPC tool returns execution mode, MCP servers, and security config
- system_health restricted to main group (returns error for non-main)
- Host process writes atomic system_health.json snapshot on request
- register_group IPC tool accepts optional executionMode parameter
- Config template documents per-group overrides with examples and safety notes
- Both host and agent-runner compile successfully
</success_criteria>

<output>
After completion, create `.planning/phases/08-per-group-overrides-and-integration/08-02-SUMMARY.md`
</output>
