# Milestone v1.0: Host-Native Runner

**Status:** SHIPPED 2026-02-12
**Phases:** 1-8
**Total Plans:** 14

## Overview

This roadmap delivers configurable execution mode switching for NanoClaw via a JSONC config file, enabling agents to run directly on macOS (host mode) alongside the existing container isolation (default). The journey starts with the config foundation that everything depends on, refactors the agent-runner for path flexibility, builds the host runner with mandatory sandbox security, adds mode-aware MCP server management, and finishes with per-group overrides and integration polish. Eight phases, each delivering a verifiable capability, with security treated as a core implementation requirement rather than post-MVP hardening.

## Phases

### Phase 1: Config Loader
**Goal**: App loads and validates a typed configuration from `nanoclaw.config.jsonc` at startup, with clear error messages on invalid config and zero behavioral change when the file is absent
**Depends on**: Nothing (first phase)
**Requirements**: CFG-01, CFG-02, CFG-03, EXEC-01
**Plans**: 2 plans

Plans:
- [x] 01-01-PLAN.md -- Core config loader: strip-json-comments dep, JSONC parsing, Zod validation, boxed error banners, singleton export
- [x] 01-02-PLAN.md -- Startup integration: wire config-loader into index.ts, verify backward compatibility

### Phase 2: Config Template and Env Expansion
**Goal**: Users have a rich, self-documenting config file they can copy and customize, with environment variable interpolation for secrets and paths
**Depends on**: Phase 1
**Requirements**: CFG-04, CFG-05
**Plans**: 1 plan

Plans:
- [x] 02-01-PLAN.md -- Config template and env expansion: create nanoclaw.config.jsonc template, add ${VAR} and ${VAR:-default} expansion to config-loader pipeline

### Phase 3: Agent-Runner Path Flexibility
**Goal**: The existing agent-runner code accepts paths via environment variables, enabling the same codebase to run inside containers (with `/workspace/*` defaults) or on the host (with absolute macOS paths)
**Depends on**: Phase 1
**Requirements**: EXEC-04, EXEC-05
**Plans**: 1 plan

Plans:
- [x] 03-01-PLAN.md -- Path-configurable agent-runner: resolvePathVar() helper, env-var-backed path constants, IPC injection, mode-driven settingSources, config docs, container rebuild

### Phase 4: Runner Abstraction and Host Runner
**Goal**: Users running in host mode get agents spawned directly on macOS as Node.js subprocesses, using the same IPC protocol and queue integration as container mode
**Depends on**: Phase 3
**Requirements**: EXEC-03
**Plans**: 2 plans

Plans:
- [x] 04-01-PLAN.md -- Host runner module: build:agent script, GroupQueue type fix, src/host-runner.ts with runHostAgent()
- [x] 04-02-PLAN.md -- Wire mode routing: index.ts and task-scheduler.ts route to correct runner, conditional container check, end-to-end verification

### Phase 5: Host Mode Security
**Goal**: Host mode agents run within macOS Seatbelt sandbox boundaries, with IPC authorization preventing cross-group access and permission controls matching the safety properties that containers provided
**Depends on**: Phase 4
**Requirements**: SEC-01, SEC-02, SEC-03, EXEC-06, EXEC-07
**Plans**: 3 plans

Plans:
- [x] 05-01-PLAN.md -- Config schema extension: hostSecurity Zod schema, ContainerInput security field, config template documentation
- [x] 05-02-PLAN.md -- Agent-runner security: conditional sandbox/permissionMode/tools, IPC write validation, permission denial hooks
- [x] 05-03-PLAN.md -- Host-runner wiring: pass security config, sandbox violation detection, WhatsApp alerts to main group

### Phase 6: MCP Server Configuration and Filtering
**Goal**: MCP servers defined in the config carry mode tags, and the runner only loads servers compatible with the current execution mode
**Depends on**: Phase 4
**Requirements**: MCP-01, MCP-02, MCP-03, MCP-05
**Plans**: 2 plans

Plans:
- [x] 06-01-PLAN.md -- Schema and filter module: McpServerSchema in config-loader, mcp-filter.ts with mode filtering and SDK translation, config template with real examples
- [x] 06-02-PLAN.md -- Pipeline wiring: ContainerInput mcpServers field, host-runner passes config servers, agent-runner filters and merges with IPC MCP, startup logging

### Phase 7: MCP Inheritance and Health Checks
**Goal**: Host mode agents inherit the user's full MCP ecosystem from global settings, and startup reports the health of all configured servers
**Depends on**: Phase 6
**Requirements**: MCP-04, MCP-06
**Plans**: 1 plan

Plans:
- [x] 07-01-PLAN.md -- Global MCP reading for source logging, health status capture from SDK init message, separate config vs global server logging

### Phase 8: Per-Group Overrides and Integration
**Goal**: Individual groups can override the global execution mode, and the full system works end-to-end with clear startup communication about the running configuration
**Depends on**: Phase 5, Phase 7
**Requirements**: GRP-01, GRP-02, GRP-03, EXEC-02
**Plans**: 2 plans

Plans:
- [x] 08-01-PLAN.md -- Per-group override data layer (type, DB, resolution function), startup validation/banner, conditional container check, per-group routing in runAgent/runTask, mode hint in responses
- [x] 08-02-PLAN.md -- system_health IPC tool (main-only), register_group executionMode param, config template documentation

## Progress

| Phase | Plans Complete | Status | Completed |
|-------|----------------|--------|-----------|
| 1. Config Loader | 2/2 | Complete | 2026-02-07 |
| 2. Config Template and Env Expansion | 1/1 | Complete | 2026-02-07 |
| 3. Agent-Runner Path Flexibility | 1/1 | Complete | 2026-02-07 |
| 4. Runner Abstraction and Host Runner | 2/2 | Complete | 2026-02-09 |
| 5. Host Mode Security | 3/3 | Complete | 2026-02-08 |
| 6. MCP Server Configuration and Filtering | 2/2 | Complete | 2026-02-10 |
| 7. MCP Inheritance and Health Checks | 1/1 | Complete | 2026-02-11 |
| 8. Per-Group Overrides and Integration | 2/2 | Complete | 2026-02-12 |

## Milestone Summary

**Key Decisions:**

- JSONC config over .env for execution config (supports comments, structured data)
- Container as default mode (safer for new users; host-native is opt-in)
- z.strictObject() for config validation (rejects unknown keys, catches typos)
- Error output via boxed ASCII banners + process.exit(1)
- Side-effect import for config-loader (prevents esbuild import elision)
- Allowlist-based env var filtering for subprocess security
- Ternary inline routing (not strategy pattern) for two execution modes
- superRefine over refine for Zod 4 dynamic error messages
- Filter MCP in agent-runner not host-runner (single filter point)
- Health status from SDK init message (not custom probes)
- resolveExecutionMode() at message-processing time (not cached)
- Safety-first: block startup when hostSecurity missing for host mode

**Issues Resolved:**

- ESM import elision (side-effect import pattern)
- pino async transport timing during module evaluation
- Cross-mode session incompatibility (retry without session)
- Zod 4 refine() only accepts static params (use superRefine)

**Issues Deferred:**

- OPS-01: Config reload on SIGHUP (v2)
- OPS-02: Per-group MCP server config (v2)
- OPS-03: Mode-switching startup diff (v2)

**Technical Debt Incurred:**

None. All phases passed verification with zero anti-patterns.

---

_For current project status, see .planning/ROADMAP.md_
